<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Page</title>
  <link rel="stylesheet" href="../mypage/mypage.css" />

  <style>
    .main-container {
      display: none;
    }
  </style>
  <script>
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn !== "true") {
      // 로그인 안된 경우 바로 리디렉션 (렌더링 이전)
      window.location.replace("../login/login.html");
    } else {
      // 로그인된 경우에만 body 보여주기
      window.addEventListener("DOMContentLoaded", function () {
        document.body.style.display = "block";
      });
    }
  </script>
</head>

<body>
  <div class="main-container">
    <div id="sidebar-container"></div>

    <div class="inner">
      <h2 class="whose-profile">unknown의 투어스</h2>
      <div class="profile-section">
        <img class="profile-image" src="../mypage/mypage_img/김기현_증명사진1.jpg" alt="프로필 이미지" />
        <div class="profile-info">
          <p class="username">
            김기현 <span class="userid">@unknown</span>
          </p>
          <div class="stats">
            <div>
              <strong class="tour-count">0<br /> 내 투어스</strong>
            </div>
            <div>
              <strong id="view-liked-places"> 좋아요 </strong>
            </div>
          </div>
        </div>
        <button class="edit-profile">
          프로필 편집
        </button>
        <button class="delete-account">회원탈퇴</button>
      </div>

      <p class="profile-message">unknown</p>
      <hr />

      <div class="tour-section">
        <h3>다녀올 투어스 🧳</h3>
        <div class="tour-list upcoming"></div>
        <!-- 다녀올 투어스 -->
      </div>

      <div class="tour-section">
        <h3>다녀온 투어스 📷</h3>
        <div class="tour-list completed"></div>
        <!-- 다녀온 투어스 -->
      </div>
    </div>
  </div>

  <!-- 모달을 동적으로 불러올 곳 -->
  <div id="modal-container"></div>

  <script>
    // fetch로 사이드바 HTML을 불러오고 나서 로그인 상태에 따라 처리
    fetch("../sidebar/sidebar.html")
      .then((res) => res.text())
      .then((data) => {
        document.getElementById("sidebar-container").innerHTML = data; // 사이드바 삽입

        // 로그인 상태에 따른 처리
        const isLoggedIn = localStorage.getItem("isLoggedIn"); // 로그인 여부 확인
        const logOutButton = document.querySelector(".sidebar-logOut"); // 로그아웃 버튼

        if (logOutButton) {
          if (isLoggedIn === "true") {
            logOutButton.style.display = "block"; // 로그인 상태일 때 버튼 보이기
          } else {
            logOutButton.style.display = "none"; // 로그인 상태가 아니면 버튼 숨기기
          }
        }
      });
  </script>

  <script src="../sidebar/sidebar.js"></script>
  <script src="../mypage/mypage.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const currentDate = new Date();
      const savedSchedules = JSON.parse(
        localStorage.getItem("savedSchedule")
      );

      if (!savedSchedules || !Array.isArray(savedSchedules)) {
        console.log("여행 일정이 없습니다.");
        return;
      }

      // 장소 데이터 로드
      let placeDataItems = [];
      try {
        const response = await fetch("../listEx.json");
        if (!response.ok)
          throw new Error("장소 데이터를 불러오는 데 실패했습니다.");
        const placeData = await response.json();
        placeDataItems = Array.isArray(placeData)
          ? placeData
          : placeData.items;
      } catch (error) {
        console.error("장소 데이터를 불러오는 중 오류 발생:", error);
      }

      const upcomingTourSection = document.querySelector(
        ".tour-section .tour-list.upcoming"
      );
      const completedTourSection = document.querySelector(
        ".tour-section .tour-list.completed"
      );

      const upcomingTours = savedSchedules.filter(
        (tour) => new Date(tour.startDate) >= currentDate
      );
      const completedTours = savedSchedules.filter(
        (tour) => new Date(tour.endDate) < currentDate
      );

      upcomingTours.sort(
        (a, b) => new Date(a.startDate) - new Date(b.startDate)
      );
      completedTours.sort((a, b) => b.index - a.index);

      function getImageForPlace(placeName) {
        const matched = placeDataItems.find(
          (place) => place.placeName === placeName
        );
        return (
          matched?.images?.[0] ||
          "https://api.cdn.visitjeju.net/photomng/imgpath/202409/20/b2087c57-7cb6-420d-a840-c6e7e581072e.png"
        );
      }

      function createTourCard(tour) {
        const { startDate, endDate, schedule, index } = tour;
        const firstPlace = schedule[0]?.places?.[0] || "여행지 미정";
        const displayTitle = tour.title?.trim() || firstPlace;

        const tourCard = document.createElement("div");
        tourCard.classList.add("tour-card");

        const tourImage = document.createElement("img");
        tourImage.classList.add("tour-image");
        tourImage.src = getImageForPlace(firstPlace);
        tourImage.alt = `${firstPlace} 여행`;

        const tourInfo = document.createElement("div");
        tourInfo.classList.add("tour-info");

        const tourTitleContainer = document.createElement("div");
        tourTitleContainer.style.display = "flex";
        tourTitleContainer.style.alignItems = "center";
        tourTitleContainer.style.gap = "8px";

        const tourTitle = document.createElement("h4");
        tourTitle.textContent = displayTitle;

        const editButton = document.createElement("button");
        editButton.textContent = "✏️";
        editButton.style.fontSize = "14px";
        editButton.style.cursor = "pointer";
        editButton.style.padding = "2px 6px";
        editButton.style.border = "1px solid #ccc";
        editButton.style.borderRadius = "4px";
        editButton.style.backgroundColor = "#f0f0f0";

        editButton.addEventListener("click", () => {
          const newTitle = prompt(
            "여행 제목을 입력하세요:",
            tourTitle.textContent
          );
          if (newTitle && newTitle.trim() !== "") {
            tourTitle.textContent = newTitle.trim();

            const allSchedules = JSON.parse(
              localStorage.getItem("savedSchedule")
            );
            const updateIndex = allSchedules.findIndex(
              (item) => item.index === index
            );
            if (updateIndex !== -1) {
              allSchedules[updateIndex].title = newTitle.trim();
              localStorage.setItem(
                "savedSchedule",
                JSON.stringify(allSchedules)
              );
            }
          }
        });

        tourTitleContainer.appendChild(tourTitle);
        tourTitleContainer.appendChild(editButton);

        const tourDate = document.createElement("p");
        tourDate.classList.add("tour-date");
        tourDate.textContent = `${startDate} ~ ${endDate}`;

        const tourPlan = document.createElement("p");
        tourPlan.classList.add("tour-plan");
        tourPlan.innerHTML = schedule
          .map((day) => {
            const date = day.date;
            const places = day.places.join(", ");
            return `<strong>${date}</strong>: ${places}`;
          })
          .join("<br />");

        tourInfo.appendChild(tourTitleContainer);
        tourInfo.appendChild(tourDate);
        tourInfo.appendChild(tourPlan);

        tourCard.appendChild(tourImage);
        tourCard.appendChild(tourInfo);

        return tourCard;
      }

      upcomingTours.forEach((tour) => {
        const card = createTourCard(tour);
        upcomingTourSection.appendChild(card);
      });

      completedTours.forEach((tour) => {
        const card = createTourCard(tour);
        completedTourSection.appendChild(card);
      });
    });
  </script>

  <script>
    // 프로필 메시지 편집 기능
    document.addEventListener('DOMContentLoaded', function () {
      const profileMessageEl = document.querySelector(".profile-message");

      // 현재 로그인된 사용자 정보를 가져오는 함수
      function getActiveUser() {
        const kakaoUser = JSON.parse(localStorage.getItem("kakao_user"));
        const naverUser = JSON.parse(localStorage.getItem("naver_user"));
        const normalUser = JSON.parse(localStorage.getItem("normal_user"));

        if (naverUser?.login === true) {
          const userData = JSON.parse(localStorage.getItem("naver_user"));
          // 닉네임
          const nickname = userData.nickname;
          // 이메일
          const email = userData.email;
          // 프로필 이미지
          const profileImg = userData.profileImg;

          // 요소에 정보 삽입
          document.querySelector(
            ".whose-profile"
          ).textContent = `${nickname} 님의 투어스`;
          document.querySelector(".profile-image").src = profileImg;
          document.querySelector(
            ".username"
          ).innerHTML = `${nickname} <span class="userid">@${email}</span>`;

          return { user: naverUser, key: "naver_user" };
        }
        else if (kakaoUser?.login === true) {
          const userData = JSON.parse(localStorage.getItem("kakao_user"));
          // 닉네임
          const nickname = userData.nickname;
          // 이메일
          const email = userData.email;
          // 프로필 이미지
          const profileImg = userData.profileImg;

          // 요소에 정보 삽입
          document.querySelector(
            ".whose-profile"
          ).textContent = `${nickname} 님의 투어스`;
          document.querySelector(".profile-image").src = profileImg;
          document.querySelector(
            ".username"
          ).innerHTML = `${nickname} <span class="userid">@${email}</span>`;
          return { user: kakaoUser, key: "kakao_user" };
        }
        else if (normalUser?.login === true) {
          const userData = JSON.parse(localStorage.getItem("normal_user"));
          // 닉네임
          const nickname = "김기현";
          // 이메일
          const email = "watergon1126";
          // 프로필 이미지
          const profileImg = "../mypage/mypage_img/김기현_증명사진1.jpg";

          // 요소에 정보 삽입
          document.querySelector(
            ".whose-profile"
          ).textContent = `${nickname} 님의 투어스`;
          document.querySelector(".profile-image").src = profileImg;
          document.querySelector(
            ".username"
          ).innerHTML = `${nickname} <span class="userid">@${email}</span>`;

          return { user: normalUser, key: "normal_user" };
        }
      }

      // 초기 프로필 메시지 로드 함수
      function loadProfileMessage() {
        const { user } = getActiveUser();
        const message = user?.profile?.profile_message || "프로필 문구 없음";
        profileMessageEl.textContent = message;
      }

      const tourCountElement = document.querySelector(".tour-count");

      const savedSchedules = JSON.parse(localStorage.getItem("savedSchedule"));
      const tourCount = Array.isArray(savedSchedules) ? savedSchedules.length : 0;

      if (tourCountElement) {
        tourCountElement.innerHTML = `<strong style="text-align:center">나의 투어스<br />${tourCount}</strong>`;
      }


      // 페이지 로드 시 메시지 출력
      loadProfileMessage();

      // ✏️ 편집 기능
      const editButton = document.querySelector(".edit-profile");
      if (!editButton) {
        console.error("편집 버튼을 찾을 수 없습니다.");
      } else {
        editButton.addEventListener("click", () => {
          const { user: activeUser, key: activeKey } = getActiveUser();

          if (!activeUser || !activeKey) {
            alert("로그인된 사용자가 없습니다.");
            return;
          }

          const currentMsg = activeUser.profile?.profile_message || "";
          const newMessage = prompt("새 프로필 문구를 입력하세요:", currentMsg);

          if (newMessage !== null && newMessage.trim() !== "") {
            const trimmed = newMessage.trim();
            activeUser.profile.profile_message = trimmed;

            // 로컬스토리지 갱신
            localStorage.setItem(activeKey, JSON.stringify(activeUser));

            // 최신 메시지 다시 로드
            loadProfileMessage();
            alert("프로필 문구가 업데이트 되었습니다.");
          }
        });
      }
    });
  </script>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const viewLikedPlacesButton = document.getElementById('view-liked-places');
      const modalContainer = document.getElementById('modal-container');

      const likedPlacesElement = document.getElementById("view-liked-places");
      const likePlaces = JSON.parse(localStorage.getItem("likePlaces"));
      const likedCount = likePlaces ? likePlaces.length : 0;

      if (likedPlacesElement) {
        likedPlacesElement.innerHTML = `좋아요<br /><strong style="text-align:center">${likedCount}</span>`;
      }

      // 모달 HTML 파일을 동적으로 불러오기
      fetch('modal.html')
        .then(response => response.text())
        .then(data => {
          modalContainer.innerHTML = data;
          const modal = document.getElementById('likedPlacesModal');
          const closeModal = document.querySelector('.close');
          const likedPlacesList = document.getElementById('likedPlacesList');

          // 좋아요 버튼 클릭 시 처리
          viewLikedPlacesButton.addEventListener('click', function () {
            console.log('좋아요 버튼 클릭됨');

            // 로컬 스토리지에서 좋아요 장소 목록 가져오기 (ID만 저장된 배열)
            const likedPlaceIds = JSON.parse(localStorage.getItem('likePlaces')) || [];
            console.log(likedPlaceIds);

            // 좋아요 목록이 없으면 경고 메시지 출력
            if (likedPlaceIds.length === 0) {
              alert('좋아요 장소가 없습니다!');
              return;
            }

            // listEx.json 파일에서 장소 데이터를 불러오기
            fetch('../listEx.json')
              .then(response => response.json())
              .then(data => {
                const places = data.items;
                const likedPlaces = places.filter(place => likedPlaceIds.includes(place.id));

                if (likedPlaces.length === 0) {
                  alert('저장된 장소가 없습니다!');
                  return;
                }

                // 모달에 좋아요 장소 목록을 표시
                likedPlacesList.innerHTML = likedPlaces.map(place => `
              <li class="liked-place-item">
                <h4>${place.placeName}</h4>
                <p>${place.description}</p>
                <p><strong>주소:</strong> ${place.address}</p>
                <p><strong>운영시간:</strong> ${place.openHours}</p>
                <p><strong>좋아요 수:</strong> ${place.likes}</p>
                <img src="${place.images[0]}" alt="${place.placeName}" />
              </li>
            `).join('');

                // 모달을 화면에 보이게 하기
                modal.style.display = 'block';
              });
          });

          // 모달 닫기 버튼 클릭 시 처리
          closeModal.addEventListener('click', function () {
            modal.style.display = 'none';
          });

          // 모달 바깥 클릭 시 모달 닫기
          window.addEventListener('click', function (event) {
            if (event.target === modal) {
              modal.style.display = 'none';
            }
          });
        });
    });

  </script>

</body>

</html>